name: 'GAWG Notify action'
description: 'This action sends a notification containing workflow info to the desired channel.'
author: √Ålvaro Garc√≠a Pizarro
branding:
  icon: 'inbox'
  color: 'gray-dark'

inputs:
  messaging_app:
    type: string
    description: 'Messaging app to send the notification to.'
    required: true
  artifact_name:
    type: string
    description: 'Name of the artifact generated by the build.'
    required: true
  technology:
    type: string
    description: 'Technology used in the project.'
    required: true
  docker:
    type: boolean
    description: 'Whether Docker is enabled or not.'
    required: true
  self-hosted-runner:
    type: boolean
    description: 'Whether self-hosted runners are used or not.'
    required: true
  deployment:
    type: string
    description: 'Deployment type.'
    required: true
  SLACK_CHANNEL:
    type: string
    description: 'Slack channel to send the notification to.'
    required: false
  SLACK_TOKEN:
    type: string
    description: 'Slack token to authenticate the request.'
    required: false
  

runs:
  using: "composite"
  steps:
    - name: Generate Workflow Summary Report
      shell: bash
      run: |
        echo ""
        echo "====================================== WORKFLOW SUMMARY ======================================="
        echo "## Workflow information" >> $GITHUB_STEP_SUMMARY
        echo "## Workflow information" >> summary.txt
        echo "üîß Technology: ${{ inputs.technology }} | Docker enabled: ${{ inputs.docker }} | Self-hosted runners: ${{ inputs.self-hosted-runner }} | Deployment type: ${{ inputs.deployment }} | Artifact name: ${{ inputs.artifact_name }}."
        echo "üîß Technology: ${{ inputs.technology }} | Docker enabled: ${{ inputs.docker }} | Self-hosted runners: ${{ inputs.self-hosted-runner }} | Deployment type: ${{ inputs.deployment }} | Artifact name: ${{ inputs.artifact_name }}." >> summary.txt
        echo "üîß Technology: ${{ inputs.technology }} | Docker enabled: ${{ inputs.docker }} | Self-hosted runners: ${{ inputs.self-hosted-runner }} | Deployment type: ${{ inputs.deployment }} | Artifact name: ${{ inputs.artifact_name }}." >> $GITHUB_STEP_SUMMARY
        echo "üë§ Workflow (${{ github.workflow }}) triggered on ${{ github.event_name }} by ${{ github.actor }} on ${{ github.repository }} repository (${{ github.ref }} branch)."
        echo "üë§ Workflow (${{ github.workflow }}) triggered on ${{ github.event_name }} by ${{ github.actor }} on ${{ github.repository }} repository (${{ github.ref }} branch)." >> summary.txt
        echo "üë§ Workflow (${{ github.workflow }}) triggered on ${{ github.event_name }} by ${{ github.actor }} on ${{ github.repository }} repository (${{ github.ref }} branch)." >> $GITHUB_STEP_SUMMARY
        echo "üÜî Workflow run ID: ${{ github.run_id }}"
        echo "üÜî Workflow run ID: ${{ github.run_id }}" >> summary.txt
        echo "üÜî Workflow run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "üïí Execution time: $(date)"
        echo "üïí Execution time: $(date)" >> summary.txt
        echo "üïí Execution time: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "üîó Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "üîó Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> summary.txt
        echo "üîó Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "==============================================================================================="

    - name: No notification needed
      if: ${{ inputs.messaging_app == 'none' }}
      shell: bash
      run: |
        echo "No notification needed. Skipping this job. Just showing the summary."  

    - name: Email notification
      if: ${{ inputs.messaging_app == 'email' }}
      shell: bash
      run: |
        echo "Sending email notification to the team."

    - name: Slack notification
      if: ${{ inputs.messaging_app == 'slack' }}
      shell: bash
      run: |
        export message=$(cat summary.txt)
        # curl -d "text=$message" -d "channel=${{ inputs.SLACK_CHANNEL }}" -H "Authorization: Bearer ${{ inputs.SLACK_TOKEN }}" -X POST https://slack.com/api/chat.postMessage

        curl -H "Content-type: application/json" \
        --data "{\"channel\":\"${{ inputs.SLACK_CHANNEL }}\",\"blocks\":[{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"$message\"}}]}" \
        -H "Authorization: Bearer ${{ inputs.SLACK_TOKEN }}" \
        -X POST https://slack.com/api/chat.postMessage

        # Crear app, instalarla en un cana. Obtener el chat ID y el token Bot user OAutu Token de la secci√≥n Install App.

    - name: Microsoft Teams notification
      if: ${{ inputs.messaging_app == 'msteams' }}
      shell: bash
      run: |
        echo "Sending Microsoft Teams notification to the team."

    - name: Discord notification
      if: ${{ inputs.messaging_app == 'discord' }}
      shell: bash
      run: |
        echo "Sending Discord notification to the team."

    - name: Telegram notification
      if: ${{ inputs.messaging_app == 'telegram' }}
      shell: bash
      run: |
        echo "Sending Telegram notification to the team."